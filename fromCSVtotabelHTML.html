<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CSV to HTML Table</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    textarea { width: 100%; }
    #csvInput { height: 150px; }
    #rawHtmlContainer { height: 200px; margin-top: 20px; font-family: monospace; width: 100%; cursor: pointer; }
    button { margin-top: 10px; padding: 8px 16px; }
    .controls { margin-bottom: 15px; display: flex; align-items: center; flex-wrap: wrap; gap: 10px; }
    .controls label { margin-left: 5px; user-select: none; margin-right: 5px;}
    .controls input[type="text"] { padding: 5px; width: 80px; }
    .controls input[type="checkbox"] { margin-left: 10px; }


    /* Stili base della tabella, sempre applicati */
    .generated-table-base {
        border-collapse:collapse;
        /* width:100%; Rimosso da qui, sarà impostato inline via JS */
        margin-top:20px;
        border:2px solid #000;
    }
    .generated-table-base th, .generated-table-base td {
        border:1px solid #000;
        padding:8px;
        text-align:left;
    }
    .generated-table-base th {
        background-color:#f4f4f4;
    }

    /* Stili aggiuntivi per la modalità word-wrap */
    .generated-table-word-wrap {
        table-layout: fixed;
    }
    .generated-table-word-wrap th, .generated-table-word-wrap td {
        overflow-wrap: break-word;
        word-wrap: break-word;
    }
  </style>
</head>
<body>
  <h1>Converti CSV in Tabella HTML</h1>
  <p>Incolla qui il tuo CSV (prima riga opzionale: <code>sep=;</code> o altro separatore)</p>
  <textarea id="csvInput" placeholder="sep=;\ncol1;col2;col3\nval1;val2;val3"></textarea>
  <br>

  <div class="controls">
    <button onclick="generaTabella()">Genera Tabella</button>
    <div>
        <input type="checkbox" id="wordWrapToggle" checked>
        <label for="wordWrapToggle">Abilita "Word Wrap"</label>
    </div>
    <div>
        <label for="tableWidthInput">Larghezza Tabella:</label>
        <input type="text" id="tableWidthInput" value="100%">
    </div>
  </div>

  <div id="tableContainer"></div>

  <h2>Raw HTML della tabella (clicca per copiare)</h2>
  <textarea id="rawHtmlContainer" readonly placeholder="Qui apparirà il codice HTML generato"></textarea>

  <script>
  function parseCsvRow(rowString, separator) {
    const regex = new RegExp(
      `(\\${separator}|\\r?\\n|\\r|^)` +
      `(?:"([^"]*(?:""[^"]*)*)"|` +
      `([^"\\${separator}\\r\\n]*))`
    , 'gi');
    const row = [];
    let matches;
    let lastIndex = 0;
    while (matches = regex.exec(rowString)) {
      if (matches.index > lastIndex && lastIndex === 0 && !rowString.startsWith('"') && !rowString.startsWith(separator)) {
           // No op
      } else if (matches.index > lastIndex && matches[1] && rowString.substring(lastIndex, matches.index) !== '') {
         if (row.length > 0 || rowString.startsWith(separator)) {
            row.push('');
         }
      }
      let value;
      if (matches[2]) {
        value = matches[2].replace(/""/g, '"');
      } else {
        value = matches[3];
      }
      row.push(value);
      lastIndex = regex.lastIndex;
    }
    if (rowString.length > 0 && rowString.charAt(rowString.length - 1) === separator && lastIndex < rowString.length) {
        row.push('');
    }
    return row;
  }

  function generaTabella() {
    const input = document.getElementById('csvInput').value.trim();
    const useWordWrap = document.getElementById('wordWrapToggle').checked;
    let tableWidth = document.getElementById('tableWidthInput').value.trim();

    if (!tableWidth) { // Se l'input è vuoto, usa il default
        tableWidth = '100%';
        document.getElementById('tableWidthInput').value = tableWidth; // Aggiorna l'input field
    }

    if (!input) {
      document.getElementById('tableContainer').innerHTML = '';
      document.getElementById('rawHtmlContainer').value = '';
      return;
    }

    const lines = input.split(/\r?\n/);
    let sep = ',';
    let startIndex = 0;

    const firstLine = lines[0];
    if (firstLine.toLowerCase().startsWith('sep=')) {
      sep = firstLine.substring(4).trim();
      startIndex = 1;
    }
    
    const nonEmptyLines = lines.slice(startIndex).filter(line => line.trim() !== '');
    
    if (nonEmptyLines.length === 0) {
        document.getElementById('tableContainer').innerHTML = '';
        document.getElementById('rawHtmlContainer').value = '';
        return;
    }

    const data = nonEmptyLines.map(line => parseCsvRow(line, sep));

    if (data.length === 0 || (data[0].length === 0 && data.length === 1 && nonEmptyLines[0].trim() === '')) { 
        document.getElementById('tableContainer').innerHTML = '';
        document.getElementById('rawHtmlContainer').value = '';
        return;
    }

    // --- Creazione Tabella per la Pagina ---
    const table = document.createElement('table');
    table.className = 'generated-table-base' + (useWordWrap ? ' generated-table-word-wrap' : '');
    table.style.width = tableWidth; // Applica la larghezza specificata

    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    if (data.length > 0 && data[0]) {
        data[0].forEach(text => {
            const th = document.createElement('th');
            th.textContent = text || "";
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);
    }

    const tbody = document.createElement('tbody');
    if (data.length > 1) {
        data.slice(1).forEach(rowData => {
            const row = document.createElement('tr');
            const headerColumnCount = data[0] ? data[0].length : 0;
            for (let i = 0; i < headerColumnCount; i++) {
                const text = rowData[i];
                const td = document.createElement('td');
                td.textContent = text || "";
                row.appendChild(td);
            }
             if (rowData.length > headerColumnCount) {
                for (let i = headerColumnCount; i < rowData.length; i++) {
                    const text = rowData[i];
                    const td = document.createElement('td');
                    td.textContent = text || "";
                    row.appendChild(td);
                }
            }
            tbody.appendChild(row);
        });
    }
    table.appendChild(tbody);

    const container = document.getElementById('tableContainer');
    container.innerHTML = '';
    container.appendChild(table);

    // --- Generazione Raw HTML con stili inline condizionali ---
    let tableStyle = `border-collapse:collapse;width:${tableWidth};margin-top:20px;border:2px solid #000;`; // Usa tableWidth
    if (useWordWrap) {
        tableStyle += 'table-layout:fixed;';
    }

    let cellStyleBase = 'border:1px solid #000;padding:8px;text-align:left;';
    let thCellStyle = cellStyleBase + 'background-color:#f4f4f4;';
    let tdCellStyle = cellStyleBase;

    if (useWordWrap) {
        const wordWrapStyle = 'overflow-wrap:break-word;word-wrap:break-word;';
        thCellStyle += wordWrapStyle;
        tdCellStyle += wordWrapStyle;
    }

    let rawHtmlString = `<table style="${tableStyle}">`;
    rawHtmlString += "<thead><tr>";
    if (data.length > 0 && data[0]) {
        data[0].forEach(text => {
            rawHtmlString += `<th style="${thCellStyle}">${(text || "")}</th>`;
        });
    }
    rawHtmlString += "</tr></thead><tbody>";
    if (data.length > 1) {
        data.slice(1).forEach(rowData => {
            rawHtmlString += "<tr>";
            const headerColumnCount = data[0] ? data[0].length : 0;
            for (let i = 0; i < headerColumnCount; i++) {
                const text = rowData[i];
                rawHtmlString += `<td style="${tdCellStyle}">${(text || "")}</td>`;
            }
            if (rowData.length > headerColumnCount) {
                for (let i = headerColumnCount; i < rowData.length; i++) {
                    const text = rowData[i];
                     rawHtmlString += `<td style="${tdCellStyle}">${(text || "")}</td>`;
                }
            }
            rawHtmlString += "</tr>";
        });
    }
    rawHtmlString += "</tbody></table>";
    document.getElementById('rawHtmlContainer').value = rawHtmlString;
  }

  const csvInput = document.getElementById('csvInput');
  csvInput.addEventListener('paste', () => setTimeout(generaTabella, 0));
  csvInput.addEventListener('input', () => setTimeout(generaTabella, 0));
  
  document.getElementById('wordWrapToggle').addEventListener('change', generaTabella);
  document.getElementById('tableWidthInput').addEventListener('input', generaTabella); // Event listener per l'input della larghezza


  document.getElementById('rawHtmlContainer').addEventListener('click', function() {
    this.select();
    try { 
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(this.value).then(() => {
          alert('HTML copiato negli appunti!');
        }).catch(err => {
          console.error('Errore clipboard API:', err);
          if (!document.execCommand('copy')) { 
            alert('La copia automatica non è supportata o è fallita. Copia manualmente.');
          } else {
            alert('HTML copiato negli appunti (fallback execCommand)!');
          }
        });
      } else {
        if (!document.execCommand('copy')) {
          alert('La copia automatica non è supportata o è fallita. Copia manualmente.');
        } else {
          alert('HTML copiato negli appunti!');
        }
      }
    }
    catch(e) { 
      alert('Errore generico durante la copia. Copia manualmente.'); 
      console.error('Errore copia:', e);
    }
  });

  // Genera una tabella vuota o di esempio all'avvio se necessario, o attendi input.
  // generaTabella(); // Puoi decommentare se vuoi una tabella generata al caricamento (basata sugli input di default)
</script>
</body>
</html>